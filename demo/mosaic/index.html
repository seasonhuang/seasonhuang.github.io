<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="format-detection" content="telephone=no">
		<title>马赛克</title>
		
		<style type="text/css">
		html,body { 
			margin: 0; 
			padding: 0; 
			width:100%; 
			height:100%; 
			overflow: hidden;
			background-color: rgba(0,0,0,.9);
		}

		body { 
			display:-webkit-box; 
			-webkit-box-orient: horizontal; 
			-webkit-box-pack: center; 
			-webkit-box-align: center; 
			text-align:center;
		}

		.control {
			position: fixed;
			left: 0;
			bottom: 0;
			width: 80%;
			height: 280px;
			background-color: white;
			padding: 0 10%;
			-webkit-transition: all .3s ease-out;
			-webkit-transform: translate3d(0,300px,0);
		}
		.control.show {
			-webkit-transition-timing-function: cubic-bezier(.54,1.63,0,.87);
			-webkit-transform: translate3d(0,100px,0);
		}
		.control.hide {
			-webkit-transition-timing-function: ease-out;
			-webkit-transform: translate3d(0,300px,0);
		}
		.range {
			margin: 0 auto;
		}
		.range label {
			display: inline-block;
			width: 20%;
			vertical-align: top;
			height: 40px;
			line-height: 40px;
		}
		.range input {
			margin: 0;
			width: 80%;
			height: 40px;
		}
		.image {
			text-align: center;
		}
		.image .btn {
			margin-top: 5px;
			width: 45%;
			display: inline-block;
		}
		button.btn {
			border: 0;
			outline: 0;
			width: 100%;
			-webkit-appearance: none;
		}
		.btn {
			display: block;
			background-color: #04be02;
			color: white;
			border-radius: 5px;
			-webkit-border-radius: 5px;
			height: 38px;
			line-height: 38px;
			text-align: center;
			box-sizing: border-box;
			-webkit-box-sizing: border-box;
			margin: 0 auto;
			padding: 0 14px;
			font-size: 15px;
		}
		.add {
			position: absolute;
			top: 50%;
			left: 50%;
			width: 80px;
			height: 80px;
			margin: -40px 0 0 -40px;
		}
		.add label {
			display: block;
			border: 1px solid rgba(255,255,255,.5);
			border-radius: 100%;
			-webkit-border-radius: 100%;
			font-size: 50px;
			color: rgba(255,255,255,.5);
			text-align: center;
			height: 80px;
			line-height: 80px;
		}
		.put-up {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 30px;
			text-align: center;
		}
		.put-up span {
			background-color: rgba(255,255,255,.8);
			margin-top: 10px;
		}
		.put-down {
			height: 20px;
			text-align: center;
			padding-top: 10px;
		}
		.put-down span {
			background-color: rgba(0,0,0,.7);
		}
		.put-up span, .put-down span {
			vertical-align: top;
			display: inline-block;
			width: 35px;
			height: 7px;
			border-radius: 7px;
		}
		</style>

		<script type="text/javascript">
		    //避免上下滚屏
		    document.addEventListener("touchmove",function(e){ e.preventDefault(); });
		</script>
</head>
<body>
	<div class="main">
		<canvas id="main" width="0" height="0"></canvas>
	</div>
    
    <div class="add">
    	<label>+<input id="add-file" type="file" accept="image/*" style="display:none;"></label>
    </div>
    <div class="put-up"><span></span></div>
    <div class="control">
    	<div class="put-down"><span></span></div>
    	<div class="range">
    		<div class="line-width">
    			<label>宽度</label><input type="range" min="1" max="10">
    		</div>
    		<div class="point-width">
    			<label>粒度</label><input type="range" min="1" max="10">
    		</div>
    	</div>
    	<div class="image">
    		<label class="btn">选择图片<input id="change-file" type="file" accept="image/*" style="display:none;"></label>
    		<button class="btn">保存图片</button> 
    	</div>
    </div>
    <script type="text/javascript">
        
        var canvas 	= document.querySelector("#main");
        var ctx 	= canvas.getContext('2d');
        var width	= canvas.width;
        var height	= canvas.height;
        var offset  = canvas.getBoundingClientRect();

        var originalWidth  = width;
        var originalHeight = height;
        var maxWidth = window.innerWidth * .9;
        
        var RAF = (function(){
        	return 	window.requestAnimationFrame		||
        			window.webkitRequestAnimationFrame	||
        			window.mozRequestAnimationFrame		||
        			window.oRequestAnimationFrame		||
        			window.msRequestAnimationFrame		||
        			function( callback ){
        				var id = window.setTimeout( callback, 1000/60 );
        				return id;
        			}
        })();

        var createObjectURL = window.createObjectURL 
                           || window.URL && window.URL.createObjectURL 
                           || window.webkitURL.createObjectURL;

        var revokeObjectURL = window.revokeObjectURL 
                           || window.URL && window.URL.revokeObjectURL 
                           || window.webkitURL.revokeObjectURL;

        var dom = {
        	add: document.querySelector('.add'),
        	addFile: document.querySelector('#add-file'),
        	changeFile: document.querySelector('#change-file'),
        	putUp: document.querySelector('.put-up'),
        	putDown: document.querySelector('.put-down'),
        	ctrl: document.querySelector('.control')
        };



        function show(dom){
        	dom.style.display = 'block';
        }

        function hide(dom){
        	dom.style.display = 'none';
        }

        function hidePanic(){
        	dom.ctrl.classList.remove('show');
        	show(dom.putUp);
        }

        function lineWidthMatrix(level){
        	var Matrix = [
        		[0],
        		[-width-1,-width,-width+1,-1,0,1,width-1,width,width+1]
        	];
        	return Matrix[level];
        }

        function onFileChange(e){
        	var file = e.target.files[0];

        	var image = new Image();
        	image.onload = function(){
        		if (this.width > maxWidth) {
        			width = canvas.width = maxWidth;
        			height = canvas.height = width/this.width * this.height;
        		} else {
        			width = canvas.width = this.width;
	        		height = canvas.height = this.height;
        		}
	        		
        		ctx.drawImage(image, 0, 0, width, height);
        		hide(dom.add);
        		revokeObjectURL(file);
        		hidePanic();
        	}
        	image.src = createObjectURL(file);
        }
        
        dom.putUp.addEventListener('touchstart', function(e){
        	e.preventDefault();
        	dom.ctrl.classList.add('show');
        	hide(dom.putUp);
        });

        dom.putDown.addEventListener('touchstart', hidePanic);
        

        dom.addFile.addEventListener('change', onFileChange);
        dom.changeFile.addEventListener('change', onFileChange);



        var lastX, lastY, imageData;
        var lineWidth = 3;

        canvas.addEventListener('touchstart', function(e){
        	e.preventDefault();
        	e.stopPropagation();

        	var touch = e.changedTouches[0];
        	imageData = ctx.getImageData(0,0,width,height);
        	offset = canvas.getBoundingClientRect();
        	lastX  = touch.clientX - offset.left;
        	lastY  = touch.clientY - offset.top;
        });

        canvas.addEventListener('touchmove', function(e){
        	e.preventDefault();
        	e.stopPropagation();

        	var touch = e.changedTouches[0];
        	var currX = touch.clientX - offset.left;
        	var currY = touch.clientY - offset.top;

        	var index = width * 4 * (currY-1) + (currX-1) * 4;

        });




        
        function render(){
        	ctx.fillStyle = 'rgb(200,200,200)';
        	ctx.fillRect(0,0,width,height);
        	
        }
        
        (function(){
        	//RAF( arguments.callee );
        	//render();
        })();

    </script>
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=43095907" charset="UTF-8"></script>
</body>
</html>